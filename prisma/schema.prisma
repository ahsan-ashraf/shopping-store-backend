generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SuperAdmin
  Admin
  Seller
  Rider
  Buyer
}

enum Gender {
  Male   @map("male")
  Female @map("female")
  Other  @map("other")
}

enum ApprovalState {
  Pending
  Approved
  Rejected
}
enum OperationalState {
  Active
  Blocked
  Suspended
}

enum paymentMethod {
  Prepaid
  PostPaid
}

enum PaymentStatus {
  Paid
  Pending
}

enum OrderStatus {
  Processing
  OutForDeliver
  Delivered
  FailedToDeliver
  Canceled
  Deleted
}

enum ReturnRequestStatus {
  ReturnRequested
  ReturnInProgress
  Returned
  Deleted
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model User {
  id            String         @id @default(uuid())
  name          String
  email         String         @unique
  dob           DateTime
  password      String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  approvalState    ApprovalState  @default(Pending)
  operationalState OperationalState @default(Active)
  role          Role
  gender        Gender
  buyer         Buyer?
  seller        Seller?
  rider         Rider?
  addresses     Address[]
  refreshTokens RefreshToken[]
}

model Buyer {
  id             String          @id @default(uuid())
  user           User            @relation(fields: [userId], references: [id])
  userId         String          @unique
  walletAmount   Decimal
  productReviews ProductReview[]
  wishlists      Wishlist[]
  carts          Cart[]
  orders         Order[]
  returnRequests ReturnRequest[]
}

model Seller {
  id         String  @id @default(uuid())
  user       User    @relation(fields: [userId], references: [id])
  userId     String  @unique
  businessId String
  IBAN       String
  stores     Store[]
}

model Rider {
  id              String          @id @default(uuid())
  user            User            @relation(fields: [userId], references: [id])
  userId          String          @unique
  vehicleRegNo    String
  companyPhone    String
  amountToRecieve Decimal         @default(0)
  orders          Order[]
  returnRequests  ReturnRequest[]
}

model Address {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  address    String
  city       String
  province   String
  postalCode String
  isPrimary  Boolean
  phone      String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  orders     Order[]
}

model Category {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  stores    Store[]
}

// we should remvoe category from store and add that to product's table
model Store {
  id                String             @id @default(uuid())
  seller            Seller             @relation(fields: [sellerId], references: [id])
  sellerId          String
  bannerImageUrl    String
  bannerImageName   String
  iconImageUrl      String
  iconImageName     String
  storeName         String
  description       String
  category          Category           @relation(fields: [categoryId], references: [id])
  categoryId        String
  youtube           String?
  facebook          String?
  instagram         String?
  tiktok            String?
  approvalState     ApprovalState  @default(Pending)
  operationalState  OperationalState @default(Active)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  storePerformances StorePerformance[]
  products          Product[]

  @@index([sellerId])
  @@index([categoryId])
}

model StorePerformance {
  id          String   @id @default(uuid())
  store       Store    @relation(fields: [storeId], references: [id])
  storeId     String
  impressions Int
  views       Int
  orders      Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Product {
  id             String          @id @default(uuid())
  store          Store           @relation(fields: [storeId], references: [id])
  storeId        String
  stock          Int
  title          String
  description    String
  brand          String
  color          String[]
  size           String[]
  images         String[]
  tags           String[]
  video          String?
  returnPolicy   Boolean
  warranty       Boolean
  rating         Decimal
  price          Decimal
  salePrice      Decimal?
  saleExpiresAt  DateTime?
  approvalState    ApprovalState  @default(Pending)
  operationalState OperationalState @default(Active)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  productReviews ProductReview[]
  productStats   ProductStat[]
  wishlists      Wishlist[]
  carts          Cart[]
  orderItems     OrderItem[]
  returnRequests ReturnRequest[]

  @@index([title]) // TODO: two stores could have products with same title, so remove this index
  @@index([storeId])
}

model ProductReview {
  id        String   @id @default(uuid())
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  buyer     Buyer?   @relation(fields: [buyerId], references: [id])
  buyerId   String?
  comment   String
  reply     String?
  images    String[]
  date      DateTime
  rating    Decimal
  operationalState OperationalState @default(Active)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductStat {
  id          String   @id @default(uuid())
  product     Product  @relation(fields: [productId], references: [id])
  productId   String
  date        DateTime
  impressions Int
  views       Int
  orders      Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Wishlist {
  id        String   @id @default(uuid())
  buyer     Buyer    @relation(fields: [buyerId], references: [id])
  buyerId   String
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // prevent from adding same product into wishlist twice
  @@unique([buyerId, productId])
}

model Cart {
  id        String   @id @default(uuid())
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  buyer     Buyer    @relation(fields: [buyerId], references: [id])
  buyerId   String
  qty       Int
  price     Decimal
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // prevent from adding same product into cart twice
  @@unique([buyerId, productId])
}

model Order {
  id                String          @id @default(uuid())
  buyer             Buyer?          @relation(fields: [buyerId], references: [id])
  buyerId           String? // optional for anonymous buyers and/or when buyer deleted but data is here for audit
  deliveryAddress   Address         @relation(fields: [deliveryAddressId], references: [id])
  deliveryAddressId String
  paymentMethod     paymentMethod
  paymentStatus     PaymentStatus
  status            OrderStatus     @default(Processing)
  operationalState  OperationalState @default(Active)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  rider             Rider?          @relation(fields: [riderId], references: [id])
  riderId           String?
  orderItems        OrderItem[]
  returnRequests    ReturnRequest[]

  @@unique([id, buyerId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id                  String   @id @default(uuid())
  order               Order    @relation(fields: [orderId], references: [id])
  orderId             String
  product             Product? @relation(fields: [productId], references: [id])
  productId           String?
  qty                 Int
  size                String
  color               String
  priceAtPurchase     Decimal
  salePriceAtPurchase Decimal
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model ReturnRequest {
  id             String              @id @default(uuid())
  buyer          Buyer?              @relation(fields: [buyerId], references: [id])
  buyerId        String?
  product        Product?            @relation(fields: [productId], references: [id])
  productId      String?
  rider          Rider?              @relation(fields: [riderId], references: [id])
  riderId        String?
  order          Order               @relation(fields: [orderId], references: [id])
  orderId        String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  reason         String
  images         String[]
  status         ReturnRequestStatus
  amountReceived Decimal

  @@index([status])
}
